%if "%{dist}" == ".el5.centos"
   %global gt_dist .Centos5
%endif

%if "%{dist}" == ".el6"
   %global gt_dist .Centos6
%endif

%if 0%{!?gt_dist:1}
   %global gt_dist %{dist}
%endif

Name:           GeneTorrent
Version:        @PACKAGE_VERSION@
Release:        1%{?gt_dist}.CP
Summary:        Transfer genomic data reliably across a network

Group:          Applications/Internet
License:        BSD
URL:            http://annaisystems.com/
Source0:        %{name}-%{version}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

Requires:       xqilla %{name}-common
Requires(pre):  shadow-utils

%if "%{dist}" == ".el5.centos"
BuildRequires:  xqilla-devel curl-devel
%else
BuildRequires:  xqilla-devel libcurl-devel openssl-devel
%endif

# This prevents binaries from being stripped of their debug bits by rpmbuild
%define __spec_install_post /usr/lib/rpm/brp-compress

%define debug_package %{nil}

%define gt_python_sitelib  %(%{__python} -c "from distutils.sysconfig import get_python_lib; import sys; sys.stdout.write(get_python_lib())")

%description
%{name}

%package common
Summary:  Libraries and common files for %{name}
Group:    Applications/Internet
License:  BSD
Requires: xqilla xerces-c
Provides: libboost_system.so
Provides: libboost_filesystem.so
Provides: libboost_regex.so
Provides: libboost_program_options.so
Provides: libtorrent-rasterbar.so
Provides: libgenetorrent.so

%description common
%{name} libraries and common files

%package download
Summary:  %{name} download client
Group:    Applications/Internet
License:  BSD
Requires: %{name}-common

%description download
%{name} download client

%package upload
Summary:  %{name} upload client
Group:    Applications/Internet
License:  BSD
Requires: %{name}-common

%description upload
%{name} upload Client

%package server
Summary:  %{name} server daemon and associated files
Group:    Applications/Internet
License:  BSD
Requires: %{name}-common

%description server
%{name} server daemon and associated files

%prep
%setup -q

%build
# must get and build boost 1.48.0 first
boost/buildGeneTorrentBoost.sh

# if centos5, must get and build openssl first
%if "%{dist}" == ".el5.centos"
openssl/buildGeneTorrentOpenSSL.sh
%endif

./configure --prefix=/usr --sysconfdir=/etc --libdir=%{_libdir} --with-boost=${PWD}/boost \
    --with-openssl=${PWD}/openssl

make %{?_smp_mflags}

%check
LD_LIBRARY_PATH="${PWD}/boost/lib:${PWD}/openssl/lib" make check

%install
[ "%{buildroot}" != "/" ] && rm -rf %{buildroot}

make install DESTDIR=%{buildroot}

rm -f %{buildroot}/%{_libdir}/%{name}/libtorrent-rasterbar.la
rm -f %{buildroot}/%{_libdir}/%{name}/pkgconfig/libtorrent-rasterbar.pc
rm -f %{buildroot}/%{_libdir}/libgenetorrent.la

%clean
[ "%{buildroot}" != "/" ] && rm -rf %{buildroot}

%files
%defattr(-,root,root,-)
%{_bindir}/%{name}
%{_mandir}/man1/%{name}*

%files common
%defattr(-,root,root,-)
%{_bindir}/gtoinfo
%{_bindir}/gtocheck
%{_datadir}/%{name}
%{_libdir}/libgenetorrent.so.0
%{_libdir}/libgenetorrent.so.0.0.0
%{_libdir}/libgenetorrent.so
%{_libdir}/%{name}/libtorrent-rasterbar.so.6
%{_libdir}/%{name}/libtorrent-rasterbar.so.6.0.0
%{_libdir}/%{name}/libtorrent-rasterbar.so
%{_libdir}/%{name}/libboost_filesystem.so
%{_libdir}/%{name}/libboost_filesystem.so.1.48.0
%{_libdir}/%{name}/libboost_program_options.so
%{_libdir}/%{name}/libboost_program_options.so.1.48.0
%{_libdir}/%{name}/libboost_regex.so
%{_libdir}/%{name}/libboost_regex.so.1.48.0
%{_libdir}/%{name}/libboost_system.so
%{_libdir}/%{name}/libboost_system.so.1.48.0
%{_libdir}/%{name}/libboost_thread.so
%{_libdir}/%{name}/libboost_thread.so.1.48.0
%if "%{dist}" == ".el5.centos"
%{_libdir}/%{name}/libssl.so
%{_libdir}/%{name}/libssl.so.1.0.0
%{_libdir}/%{name}/libcrypto.so
%{_libdir}/%{name}/libcrypto.so.1.0.0
%endif
%{gt_python_sitelib}/gtoinfo.py
%{gt_python_sitelib}/gtoinfo.pyc
%{gt_python_sitelib}/gtoinfo.pyo
%{_docdir}/%{name}/LICENSE
%{_docdir}/%{name}/README

%files upload
%defattr(-,root,root,-)
%{_bindir}/gtupload
%{_mandir}/man1/gtupload*

%files download
%defattr(-,root,root,-)
%{_bindir}/gtdownload
%{_mandir}/man1/gtdownload*

%files server
%defattr(-,root,root,-)
%{_bindir}/gtserver
%config(noreplace) %{_sysconfdir}/gnos.d/%{name}.conf
%config(noreplace) %{_sysconfdir}/gnos.d/GTLoadBalancer.conf
%{_sysconfdir}/rc.d/init.d/%{name}
%{_sysconfdir}/rc.d/init.d/GTLoadBalancer
%{_bindir}/GTLoadBalancer
%{_mandir}/man1/gtserver*

%pre common -p /sbin/ldconfig

%postun common -p /sbin/ldconfig

%pre server
/usr/bin/getent group gtorrent >/dev/null || /usr/sbin/groupadd \
   -r gtorrent >/dev/null
/usr/bin/getent passwd gtorrent >/dev/null || /usr/sbin/useradd \
   -r -g gtorrent -d /etc/gnos.d/ -s /bin/nologin gtorrent >/dev/null
exit 0

%post server
/sbin/chkconfig --add %{name}
/sbin/chkconfig --add GTLoadBalancer

%preun server
/sbin/service GeneTorrent stop > /dev/null
/sbin/service GTLoadBalancer stop > /dev/null
/sbin/chkconfig --del %{name}
/sbin/chkconfig --del GTLoadBalancer

%changelog
* Fri Aug 24 2012 Matt Lupfer <mlupfer@cardinalpeak.com> 3.4.0-1
- Split GeneTorrent into common, upload, download, and server packages
* Fri Aug 10 2012 Matt Lupfer <mlupfer@cardinalpeak.com> 3.4.0-1
- Reorganize source layout, improve RPM build process
* Mon Jul 16 2012 Matt Lupfer <mlupfer@cardinalpeak.com> 3.2.2-1
- Add site-packages dirs and gtocheck script
* Sat Jan  6 2012 donavan nelson <dnelson at cardinalpeak dot com> 1.0.x.y-1
- Prevent binaires from being stripped

